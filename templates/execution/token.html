{{ define "css" }}
  <style>
    .border-bottom-radius-0 {
      border-bottom-left-radius: 0px !important;
      border-bottom-right-radius: 0px !important;
    }
  </style>
  <style>
    .dataTables_scrollBody {
      height: 100%;
    }
    /* #transfers-table div {
      --ease-elastic-1:cubic-bezier(.5,.75,.75,1.25);
      --ease-elastic-2: cubic-bezier(.5,1,.75,1.25);
      --ease-elastic-3: cubic-bezier(.5,1.25,.75,1.25);
      aspect-ratio: 1;
      transform: scaleX(calc(0.85 + (var(--shown, 1) * 0.15)));
      transition: all 0.3s var(--ease-elastic-1);
    } */

    .overview-col {
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      /* height: 63px; */
    }

    .overview-col:nth-child(1),
    .overview-col:nth-child(2) {
      border-top: none;
    }

    .header-col,
    .overview-header-col {
      background-color: var(--bg-color-light);
      font-style: normal;
      /* font-family: 'Mukta'; */
      font-weight: 500;
      font-size: 1rem;
      line-height: 23px;
      backdrop-filter: blur(2px);
    }

    .tbl-col {
      padding: 0.5rem;
      border-top: var(--border-color) 1px solid;
    }

    .tbl-col-content {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .overview-label,
    .overview-col,
    .token-balance-col {
      font-weight: 400;
      font-size: 0.85rem;
      line-height: 23px;
      font-style: normal;
      /* font-family: 'Mukta'; */
    }
    @media screen and (min-width: 820px) {
      .overview-label,
      .overview-col,
      .token-balance-col {
        font-size: 1rem;
        font-weight: 300;
      }
    }

    .header-token {
      font-size: 1.2rem;
    }

    .header-token .text-monospace {
      font-size: 0.81rem;
    }

    @media screen and (min-width: 600px) {
      .header-token,
      .header-token .text-monospace,
      .fa-copy {
        font-size: 1.2rem;
      }
    }

    [data-theme="dark"] .qrcode-light {
      display: none;
    }
    [data-theme="dark"] .qrcode-dark {
      display: inline-block !important;
      visibility: visible !important;
    }

    [data-theme="light"] .qrcode-dark {
      display: none;
    }

    [data-theme="light"] .qrcode-light {
      display: inline-block !important;
      visibility: visible !important;
    }
  </style>
{{ end }}

{{ define "js" }}
  <script>

    window.addEventListener('resize', function(ev) {
      if(window.innerWidth >= 820) {
        $("#overview-tab").tab('show')
      }
    })

    window.addEventListener('load', function(ev) {
      if (window.innerWidth >= 820) {
        $("#overview-tab").tab('show')
      }
    })
    // const tbody = document.querySelector('#transfers-table tbody')

    // const infLoading = document.getElementById(loadingIndicatorDivId)

    // const appendRow = (row) => {
    //   tbody.appendChild(row)
    // }

    // const handleIntersection = (entries, observer) => {
    //   for (let i = 0; i < entries.length; i++) {
    //     const entry = entries[i];
    //     if (entry.isIntersecting) {
    //       // console.log('observing intersection', entry);
    //     }
    //     entry.target.style.setProperty('--shown', entry.isIntersecting ? 1 : 0)
    //   }
    // }

    // let optionsRow = {
    //   root: null,
    //   rootMargin: '0px',
    //   threshold: 0
    // }


    // let observerRow = new IntersectionObserver(handleIntersection, optionsRow);
    // const row = document.querySelectorAll('#transfers-table tbody tr')
    // row.forEach(r => {
    //   observerRow.observe(r)
    // })

    function drawCallback() {
      formatTimestamps()
      $('[data-toggle="tooltip"]').tooltip()
    }

    {{ if .TransfersTable.PagingToken }}
      setupInfiniteScroll({{.TransfersTable.PagingToken}},'transfers-table', 'transfers-table-inf-scroll', 'transfers')
    {{ end }}


    function setupInfiniteScroll(pageToken, tableID, loadingID, urlPart) {
      var previousToken = ""
      var isLoading = false

      const infLoading = document.getElementById(loadingID)
      const getTransactions = async (token) => {
        infLoading.innerText = 'Loading...'

        try {
          const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
          });

           const res = await fetch(`${window.location.pathname}/${urlPart}?pageToken=${encodeURI(token)}&a=${params.a}`)
           const data = await res.json()


           if (data && data.data && data.pagingToken && data.pagingToken.length) {
             previousToken = pageToken
             pageToken = data.pagingToken
             console.log('setting new pagetoken:\n',"new:", pageToken,'\n',"pre:", previousToken)

             // udpate the table
             for (let i = 0; i < data.data.length; i++) {
              const row = data.data[i];
              for (let j = 0; j < data.data[i].length; j++) {
                const col = data.data[i][j]
                const el = document.createElement('div')
                el.classList.add('border-top')
                el.classList.add('p-2')
                el.classList.add('text-truncate')
                el.innerHTML = col
                infLoading.insertAdjacentElement("beforebegin", el)
              }
             }
             drawCallback()
           } else if (data && data.data) {
            if (data.data.length < 25) {
              infLoading.innerText = ''
            }
           }

           isLoading = false
        } catch (err) {
          console.error("error getting transactions: ", err)
          infLoading.querySelector('h5').innerText = 'Something went wrong fetching please try again another time.'
          isLoading = false
        }
      }

      let optionsScroll = {
        root: null,
        rootMargin: '250px',
        threshold: 0
      }


      const handleTableEnd = (entries, observer) => {
        for (let i = 0; i < entries.length; i++) {
          const entry = entries[i];
          if (entry.isIntersecting) {
            // console.log('intersecting');
            if(!isLoading) {
              // console.log(tableID,'token:', pageToken)
              isLoading = true
              getTransactions(pageToken)
            }
          }
        }
      }

      let observerScroll = new IntersectionObserver(handleTableEnd, optionsScroll)

      let transactionsLastElement = document.getElementById(loadingID)
      observerScroll.observe(transactionsLastElement)
    }


  </script>
{{ end }}
{{ define "content" }}
  <div class="container mt-2">
    <div class="d-md-flex py-2 my-md-1 justify-content-md-between">
      <h1 class="h4 mb-1 mb-md-0 header-token text-truncate">
        <div class="my-md-3 font-weight-bold">
          <span class="d-flex">
            <span class="mr-1 d-flex align-items-center" title="{{ .Data.Metadata.Symbol | formatTokenSymbolTitle }}">
              {{ if .Data.Metadata.Logo }}
                <img class="mr-1" style="height: 1.5rem;" src="data:image/png;base64, {{ toBase64 .Data.Metadata.Logo }}" />
              {{ else }}
                <i class="fas fa-coins mr-1"></i>
              {{ end }}
              Token
              {{ with .Data.Metadata.Symbol | formatTokenSymbol }}{{ . }}{{ end }}
            </span>
            <span data-toggle="tooltip" title="View address QR Code" class="mx-1">{{ template "QRCode" . }}</span>
            <span class="d-flex align-items-center"><i class="fa fa-copy text-muted text-white p-1 mx-1" style="vertical-align: text-bottom; font-size: .95rem; border-radius: 35%; background-color: var(--shadow-light);" role="button" data-toggle="tooltip" title="Copy to clipboard" data-clipboard-text="{{ fixAddressCasing .Data.Token }}"></i></span>
          </span>
        </div>
        <!-- <span class="text-monospace">
          {{ .Data.Token | formatAddressLong }}
        </span> -->
      </h1>
      <div>
        {{ if .Data.Address }}
          <span class="badge badge-primary text-light my-2" style="padding: .5rem 0 .5rem .5rem">
            <span class="mr-1">Filter:</span>
            <a class="text-light text-monospace" style="width: 1rem; height: 1rem;" target="_blank" href="/address/{{ fixAddressCasing .Data.Address }}"
              >{{ fixAddressCasing .Data.Address }} <span class="text-muted text-light" data-toggle="tooltip" title="clear filter"><a class="text-light p-2" href="/token/{{ fixAddressCasing .Data.Token }}">x</a></span></a
            >
          </span>
        {{ end }}
      </div>
    </div>
    <div class="mb-3 overview-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); grid-auto-flow: row; gap: 1rem;">
      <div class="overview-content d-flex flex-column">
        <ul class="nav nav-tabs border-0 border-bottom-0 flex-grow-0" role="tablist">
          <li style="margin: 0;" class="nav-item" role="presentation">
            <a href="#overview" class="nav-link border-bottom-radius-0 border-bottom-0 active" id="overview-tab" data-toggle="tab" role="tab" aria-controls="overview" aria-selected="true">Overview</a>
          </li>
          <li style="margin: 0; border-bottom: none;" class="nav-item d-lg-none" role="presentation">
            <a href="#moreInfo" class="nav-link border-bottom-radius-0 border-bottom-0" id="moreInfo-tab" data-toggle="tab" role="tab" aria-controls="moreInfo" aria-selected="true">More Info</a>
          </li>
        </ul>
        <div class="tab-content flex-grow-1" id="overview-tab-content">
          <div class="tab-pane fade show active h-100" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <div style="border-top-left-radius: 0; border-top-right-radius: 0;" class="card h-100 shadow-none">
              <div class="card-body p-0 overview-card">
                <div style="display: grid; grid-template-columns: 2fr 4fr; grid-template-rows: auto; height: 100%;">
                  <div class="overview-col">
                    <span>Symbol</span>
                  </div>
                  <div class="overview-col">
                    <span class="d-flex align-items-center" title="{{ .Data.Metadata.Symbol | formatTokenSymbolTitle }}">
                      {{ with .Data.Metadata.Logo }}
                        <img class="mr-1" style="height: 1rem;" src="data:image/png;base64 , {{ toBase64 . }}" />
                      {{ end }}
                      {{ with .Data.Metadata.Symbol | formatTokenSymbol }}
                        {{ . }}
                      {{ end }}
                    </span>
                  </div>
                  {{ if .Data.Price }}
                    <div class="overview-col">
                      <span>Price</span>
                    </div>
                    <div class="overview-col">
                      <span style="max-width: 200px;" class="text-truncate d-inline-block">{{ .Data.Price }}</span>
                    </div>
                    <div class="overview-col">
                      <span>Market Cap</span>
                    </div>
                    <div class="overview-col">
                      <span class="">
                        {{ .Data.MarketCap }}
                      </span>
                    </div>
                  {{ end }}
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="moreInfo" role="tabpanel" aria-labelledby="moreInfo-tab">
            {{ template "TokenMoreInfoTab" . }}
          </div>
        </div>
      </div>
      <div class="overview-tab d-none d-lg-block">
        <ul class="nav nav-tabs border-0 border-bottom-0" role="tablist">
          <li style="margin: 0; border-bottom: none;" class="nav-item" role="presentation">
            <span class="nav-link border-bottom-radius-0 border-bottom-0 active" data-toggle="tab" role="tab" aria-controls="moreInfo" aria-selected="true">More Info</span>
          </li>
        </ul>
        <div class="tab-pane fade active show" id="moreInfoLarge" role="tabpanel" aria-labelledby="moreInfo-tab">
          {{ template "TokenMoreInfoTab" . }}
        </div>
      </div>
    </div>
    <!-- <h4>Info</h4>
  <ul>
    <li>Name: {{ .Data.Metadata.Name }}</li>
    <li>Symbol: {{ .Data.Metadata.Symbol }}</li>
    <li>Description: {{ .Data.Metadata.Description }}</li>
    <li>Logo: <img style="height: 20px;" src="data:image/png;base64, {{ toBase64 .Data.Metadata.Logo }}"></img></li>
    <li>Decimals: {{ bytesToNumberString .Data.Metadata.Decimals }}</li>
    <li>Total Supply: {{ bytesToNumberString .Data.Metadata.TotalSupply }}</li>
  </ul> -->
    <div class="card shadow-none">
      <div class="card-header p-0">
        {{ template "AddressTabs" . }}
      </div>
      <div class="card-body px-0 py-0">
        <div class="tab-content" id="address-tab-content">
          <div class="tab-pane fade show active" id="transfers" role="tabpanel" aria-labelledby="transaction-tab">
            {{ template "AddressTransfersTableGrid" .Data.TransfersTable }}
          </div>
        </div>
      </div>
    </div>
    {{ if .Data.QRCode }}
      {{ template "TokenQRCodeModal" . }}
    {{ end }}
  </div>
{{ end }}

{{ define "AddressTabs" }}
  <ul class="nav nav-pills border-0 border-bottom-0" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link border-bottom-radius-0 active" href="#transfers" id="transaction-tab" data-toggle="tab" role="tab" aria-controls="transfers" aria-selected="true">Transfers</a>
    </li>
  </ul>
{{ end }}

{{ define "AddressTransfersTableGrid" }}
  <div id="transfers-table" style="display: grid; grid-template-columns: repeat(3, minmax(auto, 1fr)) max-content repeat(2, minmax(auto, 1fr)); overflow-x: auto;">
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span>Hash</span></div>
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span>Age</span></div>
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span>From</span></div>
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span></span></div>
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span>To</span></div>
    <div style="z-index: 99; top: 0;" class="h5 mb-0 p-2 header-col position-sticky"><span>Quantity</span></div>

    {{ if len .Data }}
      {{ range $i, $row := .Data }}
        {{ range $j, $col := $row }}
          <div class="tbl-col">
            <div class="tblk-col-content">{{ $col }}</div>
          </div>
        {{ end }}
      {{ end }}
      {{ if gt (len .Data) 24 }}
        <div style="grid-column: 1 / 7;" id="transfers-table-inf-scroll" class="d-flex justify-content-center p-2">
          <span>loading...</span>
        </div>
      {{ end }}
    {{ else }}
      <div style="grid-column: 1 / 7;" id="transfers-table-inf-scroll" class="d-flex justify-content-center p-2">
        <div class="d-flex justify-content-center align-items-center flex-column">
          <div>
            <h5>No entries found.</h5>
          </div>
        </div>
      </div>
    {{ end }}

  </div>
{{ end }}

{{ define "TokenMoreInfoTab" }}
  <div style="border-top-left-radius: 0; border-top-right-radius: 0;" class="card h-100 shadow-none">
    <div class="card-body p-0 overview-card">
      <div style="display: grid; grid-template-columns: 2fr 4fr; grid-template-rows: auto; height: 100%;">
        <div class="overview-col">
          <span style="white-space: nowrap;">Contract Address</span>
        </div>
        <div class="overview-col text-truncate">
          <span style="max-width: 100%;" class="text-monospace text-truncate d-inline-block">
            <a class="text-truncate" href="/address/0x{{ .Data.Token }}">{{ .Data.Token | formatAddressLong }}</a>
          </span>
        </div>
        <div class="overview-col">
          <span>Supply</span>
        </div>
        <div class="overview-col">
          <span data-toggle="tooltip" title="{{ .Data.Supply }}" style="max-width: 200px;" class="text-truncate d-inline-block">{{ .Data.Supply }}</span>
        </div>
        <div class="overview-col">
          <span>Decimals</span>
        </div>
        <div class="overview-col">
          <span class="">
            {{ bytesToNumberString .Data.Metadata.Decimals }}
          </span>
        </div>
        {{ if .Data.Metadata.OfficialSite }}
          <div class="overview-col">
            <span>Site</span>
          </div>
          <div class="overview-col">
            <span class="">
              {{ .Data.Metadata.OfficialSite }}
            </span>
          </div>
        {{ end }}
        {{ if .Data.SocialProfiles }}
          <div class="overview-col">
            <span>Social Media</span>
          </div>
          <div class="overview-col">
            <span class="">
              {{ .Data.SocialProfiles }}
            </span>
          </div>
        {{ end }}
      </div>
    </div>
  </div>
{{ end }}

{{ define "QRCode" }}
  <img class="cursor-pointer qrcode-light" data-toggle="modal" data-target="#qrcode-modal" style="visibility: hidden; width: calc(1.275rem + .3vw); height: calc(1.275rem + .3vw);" src="data:image/png;base64,{{ .Data.QRCode }}" alt="QR code for address {{ fixAddressCasing .Data.Token }}" />
  <img class="cursor-pointer qrcode-dark" data-toggle="modal" data-target="#qrcode-modal" style=" display: none; width: calc(1.275rem + .3vw); height: calc(1.275rem + .3vw);" src="data:image/png;base64,{{ .Data.QRCodeInverse }}" alt="QR code for address {{ fixAddressCasing .Data.Token }}" />
{{ end }}

{{ define "TokenQRCodeModal" }}
  <div class="modal fade" id="qrcode-modal" tabindex="-1" role="dialog" aria-labelledby="qrcode-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="width: 95%; max-width: 400px; height: 375px; margin: 1.75rem auto;">
      <div class="modal-content">
        <div class="modal-header justify-content-center text-truncate">
          <span class="text-monospace text-truncate text-center font-weight-bold" style="font-size: 85%; width: 100%;">{{ fixAddressCasing .Data.Token }}</span>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <img style="visibility: hidden;" class="qrcode-light" src="data:image/png;base64,{{ .Data.QRCode }}" alt="QR code for address {{ fixAddressCasing .Data.Token }}" />
          <img style="display: none" class="qrcode-dark" src="data:image/png;base64,{{ .Data.QRCodeInverse }}" alt="QR code for address {{ fixAddressCasing .Data.Token }}" />
        </div>
      </div>
    </div>
  </div>
{{ end }}
